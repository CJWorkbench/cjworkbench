version: '3.4'
# This docker-compose.yml is only used by cloudbuild: not by devs.

services:
  testdb:
    image: postgres:10
    environment:
      POSTGRES_USER: 'cjworkbench'
      POSTGRES_PASSWORD: 'cjworkbench'
      POSTGRES_DB: 'cjworkbench'
    healthcheck:
      test: [ "CMD-SHELL", "psql -h localhost -U cjworkbench -c '\\q' "]
      interval: 1s
      retries: 3
      start_period: 120s

  testrabbitmq:
    image: rabbitmq:3.7.8-alpine
    healthcheck:
      test: [ "CMD-SHELL", "rabbitmq-diagnostics status | grep -q listeners.*clustering.*amqp" ]
      interval: 1s
      retries: 3
      start_period: 120s

  testminio:
    image: minio/minio:RELEASE.2018-09-11T01-39-21Z
    environment:
      MINIO_ACCESS_KEY: minio_access
      MINIO_SECRET_KEY: minio_secret
    command: server /data

  unittest:
    image: 'gcr.io/${PROJECT_ID}/frontend:${COMMIT_SHA}'
    # DELETEME "-k" [2018-10-30-ish] we started getting crashes on unittest
    # exit:
    #
    # Step #7: Destroying test database for alias 'default' ('test_cjworkbench')...
    # Step #7: Traceback (most recent call last):
    # Step #7: File "/usr/local/lib/python3.6/site-packages/django/db/backends/utils.py", line 63, in execute
    # Step #7: return self.cursor.execute(sql)
    # Step #7: psycopg2.OperationalError: database "test_cjworkbench" is being accessed by other users
    # Step #7: DETAIL: There are 6 other sessions using the database.
    # For now, don't delete the database: add "-k" flag.
    #
    # In the future, _do_ delete the database (remove the "-k" flag): these
    # still-being-accessed sessions are a bug.
    command: [ './manage.py', 'test', '-v2', '-k' ]
    depends_on: [ 'testdb', 'testrabbitmq', 'testminio' ]
    environment:
      PYTHONUNBUFFERED: '1'
      CJW_RABBITMQ_HOST: amqp://guest:guest@testrabbitmq
      CJW_PRODUCTION: 'True'
      CJW_DB_HOST: testdb
      CJW_DB_PASSWORD: cjworkbench
      CJW_SECRET_KEY: cjw-secret-key
      CJW_MOCK_EMAIL: 'True'
      MINIO_ACCESS_KEY: minio_access
      MINIO_SECRET_KEY: minio_secret
      MINIO_URL: http://testminio:9000
      MINIO_BUCKET_PREFIX: unittest
    # importedmodules and saveddata don't get volumes
