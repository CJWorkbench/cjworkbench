version: '3.4'

# See also:
# docker-compose.override.yml (for dev mode only -- uses 'build')
# docker-compose.cloudbuild.yml (for cloudbuild only -- uses 'image')

services:
  db:
    image: postgres:10.10
    networks:
      default:
        aliases: [ 'workbench-db' ]
    environment:
      POSTGRES_USER: 'cjworkbench'
      POSTGRES_PASSWORD: 'cjworkbench'
      POSTGRES_DB: 'cjworkbench'

  rabbitmq:
    image: rabbitmq:3.7.8
    environment:
      # Use just one CPU
      RABBITMQ_SERVER_ADDITIONAL_ERL_ARGS: '+S 1:1 +stbt ts +A 12'

  migrate:
    #image:
    #build:
    # Depends on minio because `import cjwstate.minio` pings it to ensure bucket
    # Depends on rabbitmq so that rabbitmq is already warm when we launch
    # integration-test
    depends_on: [ 'db', 'minio', 'rabbitmq' ]
    environment: &common_env
      PYTHONUNBUFFERED: '1'
      ASGI_THREADS: '2'
      CJW_PRODUCTION: 'True'
      CJW_DB_HOST: workbench-db
      CJW_DB_PASSWORD: cjworkbench
      CJW_RABBITMQ_HOST: amqp://guest:guest@rabbitmq/
      CJW_SECRET_KEY: cjw-secret-key
      CJW_MOCK_EMAIL: 'True'
      MINIO_ACCESS_KEY: minio_root_access
      MINIO_SECRET_KEY: minio_root_secret
      MINIO_URL: http://minio:9000
      MINIO_BUCKET_PREFIX: integrationtest
      TUS_CREATE_UPLOAD_URL: http://tusd/files

  minio:
    image: minio/minio:RELEASE.2020-10-12T21-53-21Z
    environment:
      MINIO_ACCESS_KEY: minio_root_access
      MINIO_SECRET_KEY: minio_root_secret
    command: server /data
    networks:
      default:
        aliases:
          - minio.django-issue-32304.com

  # In Kubernetes, we use sidecar processes to manage chroots. But we can't
  # mimic those in pure Docker, because we can't adjust mount propagation.
  # (Each container has its own mount namespace, and there's no way for
  # mounted volumes to cross namespaces.)
  #
  # Instead, we set privileged: true on each container and run
  # /app/cjwkernel/setup-sandboxes.sh before the normal command.
  #
  # [adamhooper, 2019-11-07] I'm not sure whether we need privileged: true.
  # CAP_SYS_ADMIN works on localhost, but not on Cloud Build. Perhaps apparmor
  # causes problems? Dunno. But Docker is so far removed from Kubernetes that
  # debugging this problem seems like a waste of time. We'd be better off
  # revising our integration-test framework to use Kubernetes.
  fetcher:
    #image:
    #build:
    command: [ 'sh', '-c', '/app/cjwkernel/setup-sandboxes.sh all && exec bin/fetcher-prod' ]
    depends_on: [ 'db', 'rabbitmq', 'minio' ]
    security_opt:
      - seccomp=docker/pyspawner-seccomp-profile.json
    privileged: true  # for setup-sandboxes.sh
    environment: *common_env

  renderer:
    #image:
    #build:
    command: [ 'sh', '-c', '/app/cjwkernel/setup-sandboxes.sh all && exec bin/renderer-prod' ]
    depends_on: [ 'db', 'rabbitmq', 'minio' ]
    security_opt:
      - seccomp=docker/pyspawner-seccomp-profile.json
    privileged: true  # for setup-sandboxes.sh
    environment: *common_env
    volumes:
      - local_mail:/app/local_mail

  cron:
    #image:
    #build:
    depends_on: [ 'db', 'rabbitmq', 'minio' ]
    environment: *common_env

  frontend:
    #image:
    #build:
    #no ports: on cloudbuild
    command: [ 'sh', '-c', '/app/cjwkernel/setup-sandboxes.sh only-readonly && exec bin/frontend-prod 8080' ]
    depends_on: [ 'db', 'rabbitmq', 'minio', 'tusd' ]
    security_opt:
      - seccomp=docker/pyspawner-seccomp-profile.json
    privileged: true  # for setup-sandboxes.sh
    environment:
      <<: *common_env
      STATIC_URL: http://minio.django-issue-32304.com:9000/integrationtest-static/
    volumes:
      - local_mail:/app/local_mail

  tusd:
    image: tusproject/tusd:v1.4.0
    depends_on: [ 'minio' ]
    environment:
      AWS_ACCESS_KEY_ID: minio_root_access
      AWS_SECRET_ACCESS_KEY: minio_root_secret
      AWS_REGION: us-east-1
    command: [
      '-port=80',
      '-hooks-http=http://frontend:8080/tusd-hooks',
      '-hooks-enabled-events=pre-finish',
      '-s3-endpoint=http://minio:9000',
      '-s3-bucket=integrationtest-upload',
    ]


  integration-test:
    #image:
    #build:
    depends_on: [ 'db', 'fetcher', 'renderer', 'cron', 'frontend' ]
    command: [ "sh", "-c", "until curl --output /dev/null http://frontend:8080 --silent --head --fail; do sleep 1; done; xvfb-run -a -s '-screen 0 1200x768x24' python -m unittest discover -v integrationtests -f" ]
    shm_size: 2g # prevent Firefox crashing ~5% of startups
    networks:
      default:
        aliases: [ 'module-zipfile-server' ]
    volumes:
      - local_mail:/app/local_mail
    environment:
      PYTHONUNBUFFERED: '1'
      MINIO_ACCESS_KEY: minio_root_access
      MINIO_SECRET_KEY: minio_root_secret
      MINIO_URL: http://minio:9000
      MINIO_BUCKET_PREFIX: integrationtest

volumes:
  local_mail: {}  # renderer/frontend write emails; integration-test reads them

networks:
  default: {}
